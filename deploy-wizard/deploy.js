#!/usr/bin/env node

/**
 * Script de d√©ploiement automatis√© pour QudUP sur Cloudflare
 * 
 * Ce script guide l'utilisateur √† travers le processus de d√©ploiement
 * de l'application QudUP sur Cloudflare Pages et Workers.
 */

const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');
const readline = require('readline');

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

// Couleurs pour le terminal
const colors = {
  reset: '\x1b[0m',
  bright: '\x1b[1m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  magenta: '\x1b[35m',
  cyan: '\x1b[36m',
  red: '\x1b[31m'
};

// Configuration
let config = {
  workerName: 'qudup-waitlist-api',
  d1DatabaseName: 'qudup_waitlist',
  d1DatabaseId: '',
  workerUrl: '',
  apiBaseUrl: '',
  frontendUrl: ''
};

/**
 * Affiche un message stylis√© dans le terminal
 */
function print(message, color = colors.reset, newline = true) {
  process.stdout.write(color + message + colors.reset + (newline ? '\n' : ''));
}

/**
 * Ex√©cute une commande et retourne le r√©sultat
 */
function executeCommand(command, silent = false) {
  try {
    if (!silent) {
      print(`Ex√©cution: ${command}`, colors.cyan);
    }
    return execSync(command, { encoding: 'utf8' });
  } catch (error) {
    print(`Erreur: ${error.message}`, colors.red);
    return null;
  }
}

/**
 * V√©rifie si wrangler est install√©
 */
function checkWrangler() {
  try {
    executeCommand('wrangler --version', true);
    return true;
  } catch (error) {
    return false;
  }
}

/**
 * V√©rifie si l'utilisateur est connect√© √† Cloudflare
 */
function checkCloudflareLogin() {
  try {
    const result = executeCommand('wrangler whoami', true);
    return result.includes('You are logged in');
  } catch (error) {
    return false;
  }
}

/**
 * Met √† jour le fichier wrangler.toml avec l'ID de la base de donn√©es
 */
function updateWranglerConfig(dbId) {
  try {
    let wranglerContent = fs.readFileSync(path.join(process.cwd(), 'wrangler.toml'), 'utf8');
    wranglerContent = wranglerContent.replace(/database_id = "placeholder"/, `database_id = "${dbId}"`);
    fs.writeFileSync(path.join(process.cwd(), 'wrangler.toml'), wranglerContent);
    print('‚úÖ Fichier wrangler.toml mis √† jour avec l\'ID de la base de donn√©es', colors.green);
  } catch (error) {
    print(`‚ùå Erreur lors de la mise √† jour du fichier wrangler.toml: ${error.message}`, colors.red);
  }
}

/**
 * Cr√©e un fichier .env.production pour le frontend
 */
function createEnvFile(apiUrl) {
  try {
    fs.writeFileSync(path.join(process.cwd(), '.env.production'), `VITE_API_URL=${apiUrl}`);
    print('‚úÖ Fichier .env.production cr√©√© avec l\'URL de l\'API', colors.green);
  } catch (error) {
    print(`‚ùå Erreur lors de la cr√©ation du fichier .env.production: ${error.message}`, colors.red);
  }
}

/**
 * Adapte le fichier queryClient.ts pour utiliser l'URL de l'API en production
 */
function updateQueryClient() {
  try {
    const queryClientPath = path.join(process.cwd(), 'client/src/lib/queryClient.ts');
    let content = fs.readFileSync(queryClientPath, 'utf8');
    
    // V√©rifie si le code a d√©j√† √©t√© modifi√©
    if (content.includes('import.meta.env.VITE_API_URL')) {
      print('‚úÖ Le fichier queryClient.ts est d√©j√† configur√© pour l\'API Cloudflare', colors.green);
      return;
    }
    
    // Cherche la fonction apiRequest et la modifie
    const apiRequestRegex = /(export async function apiRequest\([^)]*\) \{[^{]*\{)/;
    const replacement = '$1\n  // Utiliser l\'URL de base de l\'API en production\n  const baseUrl = import.meta.env.VITE_API_URL || \'\';\n  const fullUrl = baseUrl + url;\n';
    
    // Remplace l'URL dans le fetch
    content = content.replace(apiRequestRegex, replacement);
    content = content.replace(/fetch\(url,/, 'fetch(fullUrl,');
    
    fs.writeFileSync(queryClientPath, content);
    print('‚úÖ Le fichier queryClient.ts a √©t√© mis √† jour pour utiliser l\'API Cloudflare', colors.green);
  } catch (error) {
    print(`‚ùå Erreur lors de la mise √† jour du fichier queryClient.ts: ${error.message}`, colors.red);
  }
}

/**
 * Cr√©e le fichier _redirects pour Cloudflare Pages
 */
function createRedirectsFile() {
  try {
    const publicDir = path.join(process.cwd(), 'public');
    if (!fs.existsSync(publicDir)) {
      fs.mkdirSync(publicDir, { recursive: true });
    }
    
    fs.writeFileSync(path.join(publicDir, '_redirects'), '/* /index.html 200');
    print('‚úÖ Fichier _redirects cr√©√© pour la navigation c√¥t√© client', colors.green);
  } catch (error) {
    print(`‚ùå Erreur lors de la cr√©ation du fichier _redirects: ${error.message}`, colors.red);
  }
}

/**
 * Affiche le rapport final
 */
function showSummary() {
  print('\nüìã R√âSUM√â DU D√âPLOIEMENT', colors.bright + colors.magenta);
  print('========================', colors.magenta);
  print(`üîπ Nom du Worker: ${config.workerName}`, colors.cyan);
  print(`üîπ Base de donn√©es D1: ${config.d1DatabaseName}`, colors.cyan);
  print(`üîπ ID de la base de donn√©es: ${config.d1DatabaseId}`, colors.cyan);
  print(`üîπ URL du Worker: ${config.workerUrl || 'Non d√©ploy√©'}`, colors.cyan);
  print(`üîπ URL de base de l'API: ${config.apiBaseUrl || 'Non configur√©e'}`, colors.cyan);
  print(`üîπ URL du frontend: ${config.frontendUrl || 'Non d√©ploy√©'}`, colors.cyan);
  
  print('\n‚úÖ PROCHAINES √âTAPES', colors.bright + colors.green);
  print('=================', colors.green);
  print('1. D√©ployez le Worker (si ce n\'est pas d√©j√† fait):', colors.reset);
  print('   wrangler deploy', colors.yellow);
  print('2. Construisez le frontend:', colors.reset);
  print('   npm run build', colors.yellow);
  print('3. D√©ployez le dossier "dist" sur Cloudflare Pages via le dashboard', colors.reset);
  print('\nPour plus d\'informations, consultez le fichier:', colors.reset);
  print('deploy-wizard/cloudflare-setup-guide.md', colors.bright);
}

/**
 * Assistant de d√©ploiement interactif
 */
async function deploymentWizard() {
  return new Promise((resolve) => {
    print('\nüöÄ ASSISTANT DE D√âPLOIEMENT QUDUP SUR CLOUDFLARE üöÄ\n', colors.bright + colors.magenta);
    
    // V√©rifie les pr√©requis
    print('V√©rification des pr√©requis...', colors.cyan);
    
    if (!checkWrangler()) {
      print('‚ùå Wrangler n\'est pas install√©. Veuillez l\'installer avec:', colors.red);
      print('npm install -g wrangler', colors.yellow);
      return resolve(false);
    }
    print('‚úÖ Wrangler est install√©', colors.green);
    
    if (!checkCloudflareLogin()) {
      print('‚ùå Vous n\'√™tes pas connect√© √† Cloudflare. Veuillez vous connecter avec:', colors.red);
      print('wrangler login', colors.yellow);
      return resolve(false);
    }
    print('‚úÖ Vous √™tes connect√© √† Cloudflare', colors.green);
    
    print('\n1Ô∏è‚É£ CONFIGURATION DE LA BASE DE DONN√âES D1', colors.bright + colors.blue);
    
    rl.question('Voulez-vous cr√©er une nouvelle base de donn√©es D1? (O/n): ', (answer) => {
      if (answer.toLowerCase() !== 'n') {
        print('\nCr√©ation de la base de donn√©es D1...', colors.cyan);
        const result = executeCommand(`wrangler d1 create ${config.d1DatabaseName}`);
        
        if (result) {
          // Extrait l'ID de la base de donn√©es du r√©sultat
          const match = result.match(/database_id\s*=\s*"([^"]+)"/);
          if (match && match[1]) {
            config.d1DatabaseId = match[1];
            print(`‚úÖ Base de donn√©es D1 cr√©√©e avec l'ID: ${config.d1DatabaseId}`, colors.green);
            updateWranglerConfig(config.d1DatabaseId);
          } else {
            print('‚ùå Impossible d\'extraire l\'ID de la base de donn√©es', colors.red);
          }
        }
      } else {
        rl.question('Veuillez entrer l\'ID de votre base de donn√©es D1 existante: ', (dbId) => {
          config.d1DatabaseId = dbId.trim();
          print(`‚úÖ Utilisation de la base de donn√©es D1 avec l'ID: ${config.d1DatabaseId}`, colors.green);
          updateWranglerConfig(config.d1DatabaseId);
        });
      }
      
      print('\n2Ô∏è‚É£ CONFIGURATION DU WORKER', colors.bright + colors.blue);
      
      rl.question('Voulez-vous d√©ployer le Worker maintenant? (O/n): ', (answer) => {
        if (answer.toLowerCase() !== 'n') {
          print('\nD√©ploiement du Worker...', colors.cyan);
          const result = executeCommand('wrangler deploy');
          
          if (result) {
            // Extrait l'URL du Worker
            const match = result.match(/https:\/\/[a-zA-Z0-9-]+\.[a-zA-Z0-9-]+\.workers\.dev/);
            if (match) {
              config.workerUrl = match[0];
              config.apiBaseUrl = config.workerUrl;
              print(`‚úÖ Worker d√©ploy√© √† l'URL: ${config.workerUrl}`, colors.green);
            }
          }
        } else {
          rl.question('Veuillez entrer l\'URL de base de votre API (ex: https://qudup-waitlist-api.workers.dev): ', (url) => {
            config.apiBaseUrl = url.trim();
            print(`‚úÖ Utilisation de l'URL d'API: ${config.apiBaseUrl}`, colors.green);
          });
        }
        
        print('\n3Ô∏è‚É£ ADAPTATION DU FRONTEND', colors.bright + colors.blue);
        
        // Cr√©e le fichier .env.production
        createEnvFile(config.apiBaseUrl);
        
        // Met √† jour le client pour utiliser l'URL de l'API
        updateQueryClient();
        
        // Cr√©e le fichier _redirects
        createRedirectsFile();
        
        print('\n4Ô∏è‚É£ CONSTRUCTION DU FRONTEND', colors.bright + colors.blue);
        
        rl.question('Voulez-vous construire le frontend maintenant? (O/n): ', (answer) => {
          if (answer.toLowerCase() !== 'n') {
            print('\nConstruction du frontend...', colors.cyan);
            executeCommand('npm run build');
            print('‚úÖ Le frontend a √©t√© construit avec succ√®s dans le dossier "dist"', colors.green);
          }
          
          // Affiche le rapport final
          showSummary();
          
          print('\nüéâ L\'assistant de d√©ploiement a termin√©! üéâ\n', colors.bright + colors.magenta);
          
          rl.close();
          resolve(true);
        });
      });
    });
  });
}

// Ex√©cute l'assistant
deploymentWizard();